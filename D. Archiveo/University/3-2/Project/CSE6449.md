우리가 학부 때 배운 모델은 다음과 같다.

/ *Phong BRDF Model*
$$\begin{align}
I_\lambda &= I_{a\lambda} \cdot k_{a\lambda}+I_{l\lambda} \cdot k_{d\lambda} \cdot (N \circ L)+I_{l\lambda} \cdot k_{s\lambda} \cdot (R \circ V)^n \\
&= \text{embient reflection} + \text{diffuse reflection} + \text{specular reflection}
\end{align}$$
/ *Blinn Phong BRDF Model* `with halfway vector`
$$I_\lambda = I_{a\lambda} \cdot k_{a\lambda}+f_{att}(d) \cdot I_{l\lambda} \cdot \{ k_{d\lambda} \cdot (N \circ L)+k_{s\lambda} \cdot (N \circ H)^n \}$$

조잡하기 그지 없는 옛날 모델들이다..

최근엔 다음과 같은 모델을 쓴다.

/ *PBR(Physically Based Rendering)*
reference: Map_Physically Based Rendering Cocos Creator.pdf

![450](../../../../Z.%20Docs/img/Pasted%20image%2020240919165321.png)
- Albedo Map
- Roughness Map
- Metallic Map
- Ambient Occlusion `그림 그릴 때 그림자 강조를 위해 쓰는 곱하기나 검정 오버레이 같은거`
- Normal Map
- Emissive Map: 발광
- Stemcil Map (Alpha Channel): 최적화를 위해 멀리 있는 물체를 단순화해서 그리는 것

PBR-Specular Workflow
PBR-Metalic Workflow

/ *Rendering Equation*
$$\begin{align} L_{o}(x, \vec \omega) &= L_e(x, \vec\omega) + L_r(x, \vec\omega) \\ &= L_e(x, \vec\omega) + \int_\Omega f_{r}(x, \vec\omega', \vec\omega)L_{i}(x, \vec\omega')(\vec\omega'\cdot\vec{n})d\vec\omega' \\ &= \text{x가 카메라 방향으로 스스로 내는 빛} + \text{x에서 카메라 방향으로 방사되는 빛}&\end{align}$$
![300](../../../../Z.%20Docs/img/Pasted%20image%2020240715152030.png)

Reference
Advanced Global Illumination.pdf - 2.3 Radiometry
	flux, radiance, iradiance
Videos.txt 꼭 시청해보기
	#4, #9

### 📁 Pdf: Slide_Rendering Equation - Image Synthesis - Part 3 - Chapter 1_p

/ *Angle & Solid Angle*
![300](https://qph.cf2.quoracdn.net/main-qimg-0083ec41ebff340b26b633e285b35d31.webp)

Angle(2D) $\theta$
최대 $2\pi$ (반지름이 1인 원의 지름)

/ *Solid Angle(3D)* $\ohm$
최대 $4\pi$ (반지름이 1인 구의 면적)
반구, Hemisphere($\ohm$)의 경우 $2\pi$인 것이다.
$\int_{\ohm}\sin{\theta}\ d\theta\ d\phi = \int_{0}^{2\pi}\int^{\frac{\pi}{2}}_{0}{\sin{\theta}\ d\theta\ d\phi} = 2\pi$

/ *Radiant Flux* $\Phi$
단위 시간 당 어떤 강도로 빛 에너지가 나가고 있는가
단위: Watt $[W = \frac{J}{S}]$

/ *Radiant Intensity* $I$
$I(w) = \frac{d\Phi}{d\omega}$
특정 Solid Angle $d\omega$ 로 나가고 있는 Radiance Flux
단위: Watt per Steradian $[\frac{W}{sr}]$

/ *Irradiance* $E$
$E(x) = \frac{d\Phi}{dA}$
단위 면적 $dA$ 당 들어오는 Radiant Flux, 나가는 것도 있다. `Radiant Exitant/Radiosity`
단위: Watt per square Metre $[\frac{W}{m^2}]$

/ *Radiance* $L$
$L(x, w) = \frac{d^2\Phi}{dA\ \cos{\theta}\ d\omega}$
특정 Solid Angle과 Projected Area로 나가고 있는 Radiance Flux
단위: Watt per Steradian per square Metre $[\frac{W}{sr\ m^2}]$

$\Phi \propto dA\ d\omega$, Flux는 면적과 각도에 비례하다고 볼 수 있는데
`특정 지점에서 특정 방향으로 빛이 얼마나 세게 나가고있는가`
정확히 여기서 $dA$는 다음과 같이 progection된 면적이다.
따라서 $\cos{\theta}$를 곱해주는 것이 에너지가 정확히 수직 방향으로 들어가는 면적이다.
![](../../../../Z.%20Docs/img/Pasted%20image%2020240919173726.png)

> 왜 Radiance가 중요할까?
- 한 지점에서 특정 방향으로 $L$이라는 Radiance가 나가면 Radiance의 길이가 어떻게 되던 받아들이는 지점과 방출하는 지점의 값이 똑같을 것이다.
- 이를 이용해 Ray Tracing을 하는 것이다.
- 물론 진공 상태라는 가정 하이고, 연기나 공기가 중간에 포함되면 얘기가 또 달라진다.
- 수학적인 증명방법은 Advanced Global Illumination교재 24p. 참고

**Rendering Equation** `앞서 필기한거랑 살짝 다르긴 한데 일단 보자`

$x$라는 지점에서 $\omega_i$로 빛$L(\omega_i)$이 들어오고, $\omega_o$로 나가는 빛의 세기를 계산해보자.
$$\begin{align} L_{o}(\omega_o) &= L_e(v) + \int_\ohm f_{r}(\omega_i, \omega_o)L_{i}(\omega_i)\cos{\theta}_i\ d\omega_i \\
L_i(l) &= \frac{d^2\Phi}{dA\cos\theta\ d\omega} \\
\frac{d^2\Phi}{dA}= d(\frac{d\Phi}{dA}) &= L_i(l)\cos\theta\ d\omega \\
&= dE(l) \text{(irradiance)}
 \\ \therefore L_o(\omega_o) &= L_e(v) + \int_\ohm{f_r(\omega_i, \omega_o)\ dE(\omega_i)}\end{align}$$
- 따라서 BRDF식을 빼면 Equation에 Irradiance만 남는다.
- irradiance에 $f_r(v, l)$를 곱하고 $\ohm$ 만큼 다 더했더니 Radiance가 나온 것이다. 따라서 $f_r(v, l)$의 단위는 $\frac{\text{Radiance}}{\text{Irradiance}} = \frac{1}{sr}$가 될 것이다.
- $f_r(v, l)$: Bidirectional Reflection Distribution Function (BRDF), 얘를 어떻게 모델링 하느냐에 따라 Phong, PBR 등이 나오는 것이다.

#### BRDF
> $f_{r}(\omega_i, \omega_o)$, Material Property

$\omega$는 방향이므로 파라미터가 두 개이다. 따라서 BRDF 식은 4차원 함수이다.
만약 반구 $\ohm$을 1024개로 sampling한다고 치면 (들어오는 것) $\times$ (나가는 것) 해서 벌써 $2^{20}$이다.

Ideal Diffuse Material: 이상적인 난반사체의 경우 BRDF가 상수가 된다., $f_r(\omega_o, \omega_i) = k_d$

$$\begin{align}\rho_d &= \frac{\int_\ohm\ \{\int_\ohm f_{r}(\omega_i, \omega_o)L_{i}(\omega_i)\cos{\theta}_i\ d\omega_i \}\ \cos\theta_o\ d\omega_o}{\int_\ohm{L(\omega_i)\ \cos\theta_i\ d\omega_i}} \\ \text{Albedo (Diffuse Color)} &= \frac{\int_\ohm L(\omega_o)M(x)}{E(x)}\end{align}$$
Albedo(Diffuse Color)
어떤 한 지점의 들어오는 Flux 대비 얼만큼의 Flux가 나가는가
에너지 보존의 법칙에 의해 무조건 1보다 같거나 작아야 한다.

그렇다면 Ideal Diffuse Material 일때의 Albedo를 계산해보고 실제에 상응하는 값 나오는 것을 관찰해보자.
$$\begin{align}\rho_d &= k_d\int_\ohm\cos\theta_o \ d\omega_o \\ &=k_d\int^{2\pi}_0\int^{\frac{\pi}{2}}_0\cos\theta_o\sin\theta_o\ d\theta\ d\phi \\ &= k_d\int^{2\pi}_0[\frac12\sin^2\theta_o]^{\frac{\pi}{2}}_0\ d\phi \\ &= k_d \int^{2\pi}_0\frac12 \ d\phi = k_d \cdot \pi\end{align}$$
`첫 번째에서 두 번째 줄로 넘어가는 과정이 이해가 안 가면(이중적분) pdf 13p.를 보고오자.`
따라서 Ideal Diffuse Material의 경우 BADF의 값을 Albedo 값으로 나타내면 다음과 같다.
$$k_d = \frac{\rho_d}{\pi}$$
학부때 배운 phong 조명 모델 난반사 부분의 공식의 $k_{d\lambda}$에 해당한다.

/ *BRDF Properties*
BRDF가 식으로써 인정을 받으려면 다음과 같은 조건을 만족해야 한다. `pdf 23p.`
- Positivity: 함수값은 항상 0보다 크거나 같아야한다.
- Helmholtz Reciprocity: $l \rightarrow v = v \rightarrow l$ 즉, Bidirectional 해야한다.
- Energy Conservation: 사방에서 1만큼의 빛이 들어오면 나가는 것은 1보다 작거나 같아야 한다.

그렇다면 Phong의 모델을 BRDF로 해석하여 얼마나 조악한 모델이었는지를 살펴보자.
$$\begin{align}I_\lambda &= I_{l\lambda} \cdot \{ k_{d\lambda} \cdot (N \circ L)+k_{s\lambda} \cdot (R \circ V)^n \} \\ &= \{ k_{d\lambda} + \frac{k_{s\lambda}(R\circ V)^n}{(n\circ L)} \} \ I_{l\lambda} \cdot (N\circ L) \\ &= f_r(\omega_i, \omega_o) \ L(\omega_i)\cdot \cos\theta_i\end{align}$$
Blinn-Phong Model도 $(R\circ V)$가 $(N\circ H)$로 바뀌었을 뿐 별 다를 것도 없다.

### 📁Pdf: Slide_PBR Materials - Image Synthesis - Part 3 - Chapter 3_p

#### BRDF
$$\begin{align}&L(v) = L_e(v) + L_r(v)\\ &L(v) = L_e(v) + \int_\ohm f_{r}(v, l)L(l)\cos{\theta}\ dl \\ &f_r(v, l) = f_d(v, l) + f_s(v,, l)\end{align}$$

#### Cook-Torrance Model

/ *Material Parameter*
1. metallic(metalness) = m
```
m = 1 // metal
0 <= m <= 1
m = 0 // non-metal = dielectrics
```

왜 1과 0사이 값이 존재할까? 물체의 표면에 metal인 부분과 metal이 아닌 부분이 한 픽셀에 관찰될 수 있기 때문이다.

m의 값에 따라 specular 반사를 고려하느냐, 안 하느냐가 결정된다.
$m = 1, f_r(v, l) = f_s(v, l)$
$m = 0, f_r(v, l) = f_d(v, l) + f_s(v, l)$
따라서 실제 코드에서는 m param의 비율을 반영해서 하나의 식으로 합쳐서 쓴다.
$f_r(v, l) = \frac{\rho_d}{\pi}(1 - m) + f_s(v, l)$

2. Roughness
```
0 <= r <= 1
```

3. Reflectance
```
0 <= l <= 1
```

/ *Metal-Roughness Model vs Specular - Glossinness*
둘 중 어느 방법으로 가느냐에 따라 사용할 map들이 달라진다.

#### 📁 Base_s2013_pbs_physics_math_notes

/ Surface Scattering
Fresnel Equation을 상기해보자.
incoming light = reflection + trasmission(refraction)

빛이 들어왔을 때 Fresnel Equation에 의해서 특정 비율만큼은 reflect되고 나머지는 trasmission된다.

![300](../../../../Z.%20Docs/img/Pasted%20image%2020240926165445.png)
🔵
그런데 transmission된 빛들 중에서는 내부에서 반사되고 반사되서 물체의 색상을 머금고 다시 표면 위로 탈출하는 빛들이 있다.
이 빛들을 surface-scattered light라고 한다.

이것이 non-metal에서 가정하는 diffuse light이다.

🟡
specular reflection의 경우 metal과 같다.

![300](../../../../Z.%20Docs/img/Pasted%20image%2020240926165431.png)
🟠
반면 metal에서는 이런 현상이 없고 transmission된 빛들이 그냥 내부에서 흡수되버린다.

🟡
이제 metal에서 말하는 specular reflection에 대해서 얘기해보자.
이론상으로는 마치 거울처럼 perfect specular이 되어야 하지만 실제로는 반사각과 동일한 방향으로 살짝 퍼져서 빛이 나간다.

이 화살표의 폭이 좁아지는 경우도 있고 퍼지는 경우도 있다.
- 폭이 좁음
- 폭이 넓음
- 폭이 없음: perfect specular
이를 모델링하는 것이 **Microfacet Model**이다.

다시 본 Pdf로 돌아와보자.

/ *Microfacet BRDF*
확률적으로 빛이 들어와서 특정 굴곡을 때리면 어떤 방향으로 빛이 나갈지 각각의 굴곡 각각은 perfect specular reflection으로 나간다고 가정한다.

![](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQiWsHtE33XAfxD6njyQ9bpOfoZL7_2T3kcxQ&s)
이 굴곡, Microfacet의 정도를 확률적으로 조절하는 것이 Roughness Parameter이다.

실제 식은 다음과 같다.
$$\begin{align}&f_s(v, l) = \frac{F(v, h)\ D(h)\ G(l, v)}{4\ \langle n\cdot l\rangle \langle n\cdot v\rangle} \\ &F: \text{Fresnel reflectance} \\ &D: \text{Normal distribution function (NDF)} \\ &G: \text{Geometry term}\end{align}$$

그럼 Fresnel Reflectance에 대해서 알아보자.
아까 위에서 했던 화살표들.. 시작하기 위해선 우선 얼마나 반사되고 얼마나 들어가는지 알아야 하는 것은 자명하다.
이를 위한 게 Fresnel Reflectance이다.

기본 개념은 전에 했으니, non-metal과 metal로 나누어 parameter의 구체적인 값을 위주로 보자.
/ *Fresnel Reflectance: Non-Metal*
![450](../../../../Z.%20Docs/img/Pasted%20image%2020240926171537.png)
![450](../../../../Z.%20Docs/img/Pasted%20image%2020240926171645.png)
$F_0$: 수직광일 때의 비율이다.
대부분의 non-metal은 대게 0~4%로, 거의 다 흡수한다는 것을 볼수있다. `다이아몬드는 예외`

/ *Fresnel Reflectance: Metal*
![450](../../../../Z.%20Docs/img/Pasted%20image%2020240926171557.png)
![450](../../../../Z.%20Docs/img/Pasted%20image%2020240926172429.png)

따라서 모델링을 할 경우 Non-Metal인 경우는 그냥 값을,
Metal인 경우는 크기가 3인 Vector가 필요하다는 것을 알 수 있다. `(Linear, Float)`

잠깐 다음 식을 상기하자.
	$m = 1, f_r(v, l) = f_s(v, l)$
	$m = 0, f_r(v, l) = f_d(v, l) + f_s(v, l)$
보통 Albedo Map을 보면 기본 컬러는
Non-Metal은 $\rho_d$가,
Metal은 $F_0$값이 들어간다.

최종적으로 우리는 예전에 배웠던 Schilick Approximation을 쓴다. `빨라서`
$$F_{schlick}(v, h) = F_0 + (1.0 - F_0)(1.0 - \langle v\cdot h \rangle)^5$$
Non-Metal의 경우 vector $F_0$에 모두 같은 값 (0.04, 0.04, 0.04)이 들어가서 계산된다.

```
vec3 f0 = vec3(0.16 * (reflectance * reflectance));
```
-> 이렇게 하면 (Non-Metal의 경우) 0~16% 사이에서 값 조절이 가능하다. `다이아는 예외`
```
f0 = mix(f0, baseColor, metalic);
```
Linear Interpolation을 해주는 함수이다.
$$F_0 - \text{Base Color} \propto \text{metalic}(0.0 -1.0)$$

이제 다음, $D$ 함수를 살펴보자.
/ *Normal Distribution Function (NDF)*
이 함수는 3개 정도가 있다.
$$\begin{align}&D_{Blinn}(h)\\ &D_{Backmann}(h)\\ &D_{GGX}(h)\end{align}$$
여기서는 GGX를 쓴다.
```
float D_FFX();
```

/ *Geometry Term*
microfacet들끼리 간섭을 일으킨다.
![600](../../../../Z.%20Docs/img/Pasted%20image%2020240926174826.png)
- Masking Effect
- Shadowing Effect
$$G_{Cook-Torrance}(l, v) = min(a, ..)$$
여기서는 Smith를 쓴다.
```
float G_Smith();
```

#### Introduction

본 문서는 CSE4170을 수강하여 Phong `혹은 Blinn-Phong` Model 정도만 이해하고 있다는 가정하에 **PBR(Physically-Based Rendering) Shading Model**을 설명하게 위해 작성되었다.

# 1. What is PBR?

우리가 학부 때 배운 모델은 다음과 같다.

/ *Phong BRDF Model*
$$\begin{align}
I_\lambda &= I_{a\lambda} \cdot k_{a\lambda}+I_{l\lambda} \cdot k_{d\lambda} \cdot (N \circ L)+I_{l\lambda} \cdot k_{s\lambda} \cdot (R \circ V)^n \\
&= \text{embient reflection} + \text{diffuse reflection} + \text{specular reflection}
\end{align}$$
/ *Blinn Phong BRDF Model* `with halfway vector`
$$I_\lambda = I_{a\lambda} \cdot k_{a\lambda}+f_{att}(d) \cdot I_{l\lambda} \cdot \{ k_{d\lambda} \cdot (N \circ L)+k_{s\lambda} \cdot (N \circ H)^n \}$$

이른 바 옛날 모델들로, 렌더링에 대한 기본 지식을 익히는 데에는 중요하나 최신 모델들이냐 하면 그렇지 않다.

그렇다면 최근엔 어떤 모델을 쓸까? 그것이 바로 PBR(Physically Based Rendering) Model이다.

#### PBR (Physically Based Rendering)
> 실제 세계의 물리적 특성을 기반으로 하는 렌더링 기법이다.

# 2. Rendering Equation

학부 때 배웠던 Rendering Equation을 상기해보자.
$$\begin{align} L_{o}(x, \vec \omega) &= L_e(x, \vec\omega) + L_r(x, \vec\omega) \\ &= L_e(x, \vec\omega) + \int_\Omega f_{r}(x, \vec\omega', \vec\omega)L_{i}(x, \vec\omega')(\vec\omega'\cdot\vec{n})d\vec\omega' \\ &= \text{x가 카메라 방향으로 스스로 내는 빛} + \text{x에서 카메라 방향으로 방사되는 빛}&\end{align}$$
아마 그 때는 자세히 하지 않고 넘어갔을 것이다.
본격적으로 PBR에 대해서 하기 전에, 우리는 이 Rendering Equation에 대해서 정확히 알고 갈 필요가 있다.

# 3. PBR Materials
